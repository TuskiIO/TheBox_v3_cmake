# TheBox V3.0 - 磁传感器采集系统

## 项目概述

本项目是基于STM32F722的磁传感器数据采集系统，通过RS485/Modbus RTU总线连接多个磁传感器模块，通过USB虚拟串口将数据发送到PC端。

**主要特性：**
- 支持最多246个磁传感器（地址1-245，广播地址0x00，临时地址0xF7）
- USB 2.0 HS/FS可切换虚拟串口通信
- RS485通信波特率：2Mbps
- 自动检测新传感器并分配SlaveID
- 实时数据采集和时间戳同步

---

## 硬件连接

### MCU引脚定义

| 引脚名称 | GPIO | 方向 | 功能说明 |
|---------|------|------|---------|
| `SENS_PWR_EN` | PB9 | 输出 | **传感器电源使能**（高电平有效）|
| `USB_RESETB` | PA2 | 输出 | USB PHY复位（低电平有效）|
| `INPUT_PWR_ST` | PB15 | 输入 | 外部电源状态检测 |
| `IMU_INT` | PC11 | 输入 | ICM42688P中断引脚 |
| `LED1` | PC15 | 输出 | 状态指示灯1 |
| `LED2` | PC14 | 输出 | 状态指示灯2（闪烁中）|

### 外设配置

| 外设 | 引脚 | 配置参数 |
|-----|------|---------|
| **UART4** | RS485通信 | 2Mbps, 8N1, DMA接收 |
| **SPI3** | ICM42688P | Master模式, 8bit数据 |
| **USB HS** | USB_ULPI | 480MHz高速模式 |
| **USB FS** | USB_FS | 12MHz全速模式 |
| **CRC** | 内部 | 硬件CRC16校验 |
| **TIM2** | 延时定时器 | 1MHz计数频率 |
| **TIM4** | 辅助定时器 | 用于延时 |

### 电路连接示意图

```
                    ┌─────────────────┐
                    │   STM32F722     │
                    │                 │
    USB_PC ────────►│ USB_HS/FS      │
                    │                 │
                    │   UART4   ┌────► TX ──┐
                    │   (RS485) │         │
                    │           └────► RX ──┼──► RS485总线 ──► 磁传感器1~N
                    │                     │        │
                    │   SENS_PWR_EN ──────┘        │
                    │   PB9 (输出)                  │
                    │                               │
                    │   SPI3 ──────────────────► ICM42688P
                    │   IMU_INT ◄─────────────────┘
                    │   PC11 (输入)
                    │                 │
                    └─────────────────┘
```

---

## 编译说明

### 编译环境要求

- **IDE**: STM32CubeCLT + CMake + Ninja
- **工具链**: ARM GNU Toolchain (arm-none-eabi-gcc)
- **CMake**: 版本 3.22+

### 编译步骤

```bash
# 1. 配置CMake（使用Ninja生成器）
cmake -B build -S . -G Ninja -DCMAKE_TOOLCHAIN_FILE=cmake/gcc-arm-none-eabi.cmake -DCMAKE_BUILD_TYPE=Debug

# 2. 编译项目
cmake --build build --config Debug

# 3. 输出文件
# build/TheBox_V3_0.elf    - ELF可执行文件
# build/TheBox_V3_0.hex    - Intel HEX格式（用于烧录）
# build/TheBox_V3_0.bin    - 二进制文件
# build/TheBox_V3_0.map    - 内存映射文件
```

### 编译配置切换

**USB端口切换：** 修改以下文件中的宏定义

```c
// usbd_cdc_if.h (第56行)
#define USE_USB_HS  1    // 1=USB HS, 0=USB FS

// main.c (第43行)
#define USE_USB_HS  1    // 1=USB HS, 0=USB FS

// usb_comm.c (第21行)
#define USE_USB_HS  1    // 1=USB HS, 0=USB FS
```

### 内存占用

```
Memory region         Used Size  Region Size  %age Used
     RAM:      104760 B       256 KB     39.96%
   FLASH:       50056 B       512 KB      9.55%
```

---

## 程序逻辑

### 1. 系统初始化流程

```
系统上电
    │
    ├─► HAL_Init()                         // HAL库初始化
    │
    ├─► SystemClock_Config()               // 配置216MHz系统时钟
    │
    ├─► 外设初始化
    │     ├─► MX_GPIO_Init()               // GPIO初始化
    │     ├─► MX_UART4_Init()              // RS485: 2Mbps
    │     ├─► MX_SPI3_Init()               // IMU SPI
    │     ├─► MX_CRC_Init()                // CRC校验
    │     ├─► MX_USB_DEVICE_Init()         // USB CDC (x2)
    │     ├─► MX_TIM2_Init()               // 微秒延时
    │     └─► MX_TIM4_Init()               // 辅助定时
    │
    ├─► 应用层初始化
    │     ├─► usb_comm_init()              // USB通信层
    │     ├─► SENS_PWR_EN = HIGH           // 使能传感器电源
    │     ├─► HAL_Delay(1000)              // 等待传感器上电
    │     ├─► 时间戳初始化
    │     ├─► Check_MagSensors_SlaveID()   // 扫描已有传感器ID
    │     ├─► Get_MagSensors_Plugged()     // 检测新传感器并分配ID
    │     ├─► Get_MagSensor_Config()       // 读取所有传感器配置
    │     ├─► ICM42688_Init()              // IMU初始化
    │     └─► 启动UART4 DMA接收
    │
    └─► 进入主循环
```

### 2. 主循环逻辑

```
while(1) {
    │
    ├─► 【数据采集】if(usb_get_sensor_data_flag == 1)
    │     ├─► Modbus_CMD60_TriggerMeasurement(0x00)  // 广播触发测量
    │     ├─► Update_TimeStamp()                      // 更新时间戳
    │     ├─► HAL_Delay(5)
    │     ├─► Get_MagSensors_Data()                   // 读取所有传感器数据
    │     ├─► PC_TRANS_Assemble(timestamp)            // 打包数据
    │     └─► CDC_Transmit_HS/FS(buffer, len)         // USB发送
    │
    ├─► 【配置设置】if(usb_set_sensor_cfg_flag == 1)
    │     ├─► Set_MagSensor_Config(usb_to_485_buf)    // 写入传感器配置
    │     ├─► 打包响应数据
    │     └─► USB回复
    │
    ├─► 【配置读取】if(usb_get_sensor_cfg_flag == 1)
    │     ├─► Get_MagSensor_Config()                  // 读取传感器配置
    │     ├─► 打包配置数据
    │     └─► USB回复
    │
    ├─► LED2闪烁 (约500ms周期)
    │
    └─► HAL_Delay(5)
}
```

### 3. 传感器检测流程

```
Check_MagSensors_SlaveID()
    │
    └─► 扫描地址 0x01~0xF6
          └─► 记录响应的传感器ID到slaveID_map[]

Get_MagSensors_Plugged()
    │
    ├─► 发送CMD61广播请求UID (临时ID 0xF7)
    │     └─► 等待100ms (初次) / 1ms (后续)
    │
    ├─► 收到0xF7响应 → 解析UID
    │     │
    │     ├─► Find_Free_SlaveID()        // 查找空闲ID
    │     ├─► 发送CMD62设置新SlaveID
    │     ├─► 重试2次直到成功
    │     └─► 更新slaveID_map[]
    │
    └─► 返回 HAL_OK/HAL_TIMEOUT
```

---

## 数据输出格式

### USB数据包结构（MCU → PC）

```
┌─────────────────────────────────────────────────────────────────────┐
│ 帧头 (3字节)                                                        │
├─────────────────────────────────────────────────────────────────────┤
│ 0x55 | 0xaa | 0xff                                                 │
└─────────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────────┐
│ 传感器数量 (1字节)                                                  │
├─────────────────────────────────────────────────────────────────────┤
│ sensor_num (0~246)                                                 │
└─────────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────────┐
│ 时间戳 (8字节, double)                                             │
├─────────────────────────────────────────────────────────────────────┤
│ mcu_timestamp (单位: 秒)                                           │
└─────────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────────┐
│ 错误包率 (4字节, float)                                            │
├─────────────────────────────────────────────────────────────────────┤
│ (sensor_err_pkg_cnt / sensor_pkg_cnt) * 10000                     │
└─────────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────────┐
│ 传感器数据 (每个传感器17字节)                                      │
├─────────────────────────────────────────────────────────────────────┤
│ [SlaveID (1)] [UID32 (4)] [magX (4)] [magY (4)] [magZ (4)]        │
│    └─ 重复 sensor_num 次                                          │
└─────────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────────┐
│ CRC16校验 (2字节)                                                  │
├─────────────────────────────────────────────────────────────────────┤
│ CRC16 (多项式: 0x8005, 初值: 0xFFFF)                              │
└─────────────────────────────────────────────────────────────────────┘
```

### 数据包示例

```
位置    内容                            说明
────────────────────────────────────────────────────────────
0x00    0x55                            帧头标志1
0x01    0xaa                            帧头标志2
0x02    0xff                            帧头标志3
0x03    0x03                            传感器数量 = 3
0x04    0x00 0x00 0x00 0x00 0x00 0x00 0x40 0x40    timestamp = 25.0s
0x0C    0x00 0x00 0x00 0x00              错误包率 = 0.0%
0x10    0x01                            传感器1 SlaveID
0x11    0x12 0x34 0x56 0x78              传感器1 UID
0x15    0x00 0x00 0x00 0x3F              magX = 0.5f
0x19    0x00 0x00 0x00 0x40              magY = 2.0f
0x1D    0x00 0x00 0x00 0x41              magZ = 8.0f
0x21    0x02                            传感器2 SlaveID
...     (重复)
0x??    0xAB 0xCD                        CRC16
```

---

## 配置命令格式

### 设置传感器配置（PC → MCU → RS485）

**USB接收格式：**
```
| SlaveID (1) | StartReg (1) | Length (1) | Data (N) |
```

**处理流程：**
```c
// main.c: 199-227
if(usb_set_sensor_cfg_flag == 1) {
    Set_MagSensor_Config(usb_to_485_buf);
    // 回复: 0x55 0xaa 0xff [原RS485响应] [CRC16]
    usb_set_sensor_cfg_flag = 0;
}
```

**USB响应格式：**
```
┌────────────────────────────────────────┐
│ 0x55 | 0xaa | 0xff                     │  帧头
├────────────────────────────────────────┤
│ [RS485响应数据]                        │  原样回显
├────────────────────────────────────────┤
│ CRC16 (2)                              │  校验
└────────────────────────────────────────┘
```

### 读取传感器配置（PC → MCU → RS485）

**USB接收格式：**
```
| SlaveID (1) | 请求读取配置 |
```

**USB响应格式：**
```
┌────────────────────────────────────────┐
│ 0x55 | 0xaa | 0xff                     │  帧头
├────────────────────────────────────────┤
│ SENSOR_Public_Config_t (52字节)        │  传感器公共配置
├────────────────────────────────────────┤
│ CRC16 (2)                              │  校验
└────────────────────────────────────────┘
```

---

## Modbus命令说明

| 命令码 | 功能 | 方向 |
|-------|------|-----|
| CMD50 (0x50) | 读寄存器 | MCU → 传感器 |
| CMD51 (0x51) | 写寄存器 | MCU → 传感器 |
| CMD60 (0x60) | 触发测量 | MCU → 传感器 |
| CMD61 (0x61) | 请求UID广播 | MCU → 0xF7 |
| CMD62 (0x62) | 设置SlaveID | MCU → 0xF7 |

---

## 注意事项

### 1. 电源时序

```
上电顺序:
1. MCU上电
2. 初始化所有外设
3. SENS_PWR_EN = HIGH (PB9输出高电平)
4. 等待1000ms (传感器稳定时间)
5. 开始传感器检测
```

### 2. RS485通信

- **波特率**: 2Mbps（通过CubeMX配置UART4）
- **总线空闲**: 需要5ms超时检测帧结束
- **DMA接收**: 使用`HAL_UARTEx_ReceiveToIdle_DMA()`
- **终端电阻**: 总线两端需要120Ω电阻

### 3. USB通信

- **虚拟串口**: CDC类，驱动自动识别
- **发送缓冲**: 2048字节 (APP_TX_DATA_SIZE)
- **接收缓冲**: 2048字节 (APP_RX_DATA_SIZE)
- **HS/FS切换**: 通过`USE_USB_HS`宏统一配置

### 4. 传感器地址

- **有效地址**: 0x01 ~ 0xF6 (1~246)
- **广播地址**: 0x00
- **临时地址**: 0xF7 (未分配ID时使用)
- **保留地址**: 0xF8 ~ 0xFF

### 5. 时间戳

- **单位**: 秒 (double精度)
- **基准**: TIM2定时器计数
- **同步**: 可通过写寄存器同步传感器时间

### 6. 调试输出

启用`USE_USB_PRINTF`宏可在USB串口输出调试信息：

```c
// usbd_cdc_if.h
#define USE_USB_PRINTF  1    // 0=关闭, 1=开启
```

---

## 目录结构

```
TheBox_v3_camke/
├── Core/
│   ├── Inc/           # 头文件
│   └── Src/           # 源文件 (main.c, stm32f7xx_it.c等)
├── Drivers/           # STM32 HAL驱动
├── Middlewares/       # USB设备库
├── USB_DEVICE/        # USB CDC实现
├── modbus_rtu/        # Modbus RTU协议层
├── ICM42688P/         # IMU驱动
├── usb_comm/          # USB通信封装层
├── cmake/             # CMake构建配置
├── build/             # 编译输出目录
└── README.md          # 本文档
```

---

## 版本历史

| 版本 | 日期 | 说明 |
|-----|------|-----|
| V3.0 | 2026-01 | STM32F722移植，USB通信替代UDP |

---

## 许可证

Copyright (c) 2026 STMicroelectronics. All rights reserved.
