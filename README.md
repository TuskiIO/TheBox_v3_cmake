# MagLoc V3.0 TheBox

## 项目概述

本项目是基于STM32F722的磁传感器数据采集系统，通过RS485/Modbus RTU总线连接多个磁传感器模块，通过USB虚拟串口将数据发送到PC端。

**主要特性：**
- 支持最多246个磁传感器（地址1-245，广播地址0x00，临时地址0xF7）
- USB 2.0 HS/FS可切换虚拟串口通信
- RS485通信波特率：2Mbps
- 自动检测新传感器并分配SlaveID
- 实时数据采集和时间戳同步

---

## 硬件连接

### MCU引脚定义

| 引脚名称 | GPIO | 方向 | 功能说明 |
|---------|------|------|---------|
| `SENS_PWR_EN` | PB9 | 输出 | **传感器电源使能**（高电平有效）|
| `USB_RESETB` | PA2 | 输出 | USB PHY复位（低电平有效）|
| `INPUT_PWR_ST` | PB15 | 输入 | 外部电源状态检测 |
| `IMU_INT` | PC11 | 输入 | ICM42688P中断引脚 |
| `LED1` | PC15 | 输出 | 状态指示灯1 |
| `LED2` | PC14 | 输出 | 状态指示灯2（闪烁中）|

### 外设配置

| 外设 | 引脚 | 配置参数 |
|-----|------|---------|
| **UART4** | RS485通信 | 2Mbps, 8N1, DMA接收 |
| **SPI3** | ICM42688P | Master模式, 8bit数据 |
| **USB HS** | USB_ULPI | 480MHz高速模式 |
| **USB FS** | USB_FS | 12MHz全速模式 |
| **CRC** | 内部 | 硬件CRC16校验 |
| **TIM2** | 延时定时器 | 1MHz计数频率 |
| **TIM4** | 辅助定时器 | 用于延时 |

### 电路连接示意图

```
                    ┌───────────────────────┐
                    │   STM32F722           │
                    │                       │
    USB_PC ────────►│ USB_HS/FS             │
                    │                       │
                    │                 ┌────► TX ──┐
                    │           RS485 │     │     ┼─► RS485总线 ──► 磁传感器1~N
                    │                 └────► RX ──┘
                    │                   │   │     
                    │   SENS_PWR_EN ────┘   │  
                    │                       │
                    │                       │
                    │   SPI3 ───► ICM42688P │
                    │   IMU_INT ◄────┘      │
                    │                       │
                    │                       │
                    └───────────────────────┘
```

---

## 编译说明

### 编译环境要求

- **IDE**: STM32CubeCLT + CMake + Ninja
- **工具链**: ARM GNU Toolchain (arm-none-eabi-gcc)
- **CMake**: 版本 3.22+

### 编译步骤

```bash
# 1. 配置CMake（使用Ninja生成器）
cmake -B build -S . -G Ninja -DCMAKE_TOOLCHAIN_FILE=cmake/gcc-arm-none-eabi.cmake -DCMAKE_BUILD_TYPE=Debug

# 2. 编译项目
cmake --build build --config Debug

# 3. 输出文件
# build/TheBox_V3_0.elf    - ELF可执行文件
# build/TheBox_V3_0.hex    - Intel HEX格式（用于烧录）
# build/TheBox_V3_0.bin    - 二进制文件
# build/TheBox_V3_0.map    - 内存映射文件
```

### 编译配置切换

**USB端口切换：** 修改以下文件中的宏定义

```c
// usbd_cdc_if.h (第56行)
#define USE_USB_HS  1    // 1=USB HS, 0=USB FS

// main.c (第43行)
#define USE_USB_HS  1    // 1=USB HS, 0=USB FS

// usb_comm.c (第21行)
#define USE_USB_HS  1    // 1=USB HS, 0=USB FS
```

### 内存占用

```
Memory region         Used Size  Region Size  %age Used
     RAM:      104760 B       256 KB     39.96%
   FLASH:       50056 B       512 KB      9.55%
```

---

## 程序逻辑

### 1. 系统初始化流程

```
系统上电
    │
    ├─► HAL_Init()                         // HAL库初始化
    │
    ├─► SystemClock_Config()               // 配置216MHz系统时钟
    │
    ├─► 外设初始化
    │     ├─► MX_GPIO_Init()               // GPIO初始化
    │     ├─► MX_UART4_Init()              // RS485: 2Mbps
    │     ├─► MX_SPI3_Init()               // IMU SPI
    │     ├─► MX_CRC_Init()                // CRC校验
    │     ├─► MX_USB_DEVICE_Init()         // USB CDC (x2)
    │     ├─► MX_TIM2_Init()               // 微秒延时
    │     └─► MX_TIM4_Init()               // 辅助定时
    │
    ├─► 应用层初始化
    │     ├─► usb_comm_init()              // USB通信层
    │     ├─► SENS_PWR_EN = HIGH           // 使能传感器电源
    │     ├─► HAL_Delay(1000)              // 等待传感器上电
    │     ├─► 时间戳初始化
    │     ├─► Check_MagSensors_SlaveID()   // 扫描已有传感器ID
    │     ├─► Get_MagSensors_Plugged()     // 检测新传感器并分配ID
    │     ├─► Get_MagSensor_Config()       // 读取所有传感器配置
    │     ├─► ICM42688_Init()              // IMU初始化
    │     └─► 启动UART4 DMA接收
    │
    └─► 进入主循环
```

### 2. 主循环逻辑

```
while(1) {
    │
    ├─► 【数据采集】if(usb_get_sensor_data_flag == 1)
    │     ├─► Modbus_CMD60_TriggerMeasurement(0x00)  // 广播触发测量
    │     ├─► Update_TimeStamp()                      // 更新时间戳
    │     ├─► HAL_Delay(5) /[DRDY模式]等待传感器DRDY信号
    │     ├─► Get_MagSensors_Data()                   // 读取所有传感器数据
    │     ├─► PC_TRANS_Assemble(timestamp)            // 打包数据
    │     └─► CDC_Transmit_HS/FS(buffer, len)         // USB发送
    │
    ├─► 【配置设置】if(usb_set_sensor_cfg_flag == 1)
    │     ├─► Set_MagSensor_Config(usb_to_485_buf)    // 写入传感器配置
    │     ├─► 打包响应数据
    │     └─► USB回复
    │
    ├─► 【配置读取】if(usb_get_sensor_cfg_flag == 1)
    │     ├─► Get_MagSensor_Config()                  // 读取传感器配置
    │     ├─► 打包配置数据
    │     └─► USB回复
    │
    ├─► LED2闪烁 (约500ms周期)
    │
    └─► HAL_Delay(5)
}
```

### 3. 传感器检测流程

```
Check_MagSensors_SlaveID()
    │
    └─► 扫描地址 0x01~0xF6
          └─► 记录响应的传感器ID到slaveID_map[]

Get_MagSensors_Plugged()
    │
    ├─► 发送CMD61广播请求UID (临时ID 0xF7)
    │     └─► 等待100ms (初次) / 1ms (后续)
    │
    ├─► 收到0xF7响应 → 解析UID
    │     │
    │     ├─► Find_Free_SlaveID()        // 查找空闲ID
    │     ├─► 发送CMD62设置新SlaveID
    │     ├─► 重试2次直到成功
    │     └─► 更新slaveID_map[]
    │
    └─► 返回 HAL_OK/HAL_TIMEOUT
```

---

## USB通信协议

### 协议概述

为区分PC→MCU命令和MCU→PC响应，使用**不同的帧头**：

| 方向 | 帧头格式 | 字节数 | 用途 |
|-----|---------|--------|------|
| PC → MCU | `0xAA 0x55 0x00 0xFF` | 4字节 | 命令帧 |
| MCU → PC | `0x55 0xAA 0xFF` | 3字节 | 响应帧/数据帧 |

---

## 数据输出格式（MCU → PC）

### USB数据包结构

```
┌─────────────────────────────────────────────────────────────────────┐
│ 帧头 (3字节)                                                        │
├─────────────────────────────────────────────────────────────────────┤
│ 0x55 | 0xAA | 0xFF                                                 │
└─────────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────────┐
│ 传感器数量 (1字节)                                                  │
├─────────────────────────────────────────────────────────────────────┤
│ sensor_num (0~246)                                                 │
└─────────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────────┐
│ 时间戳 (8字节, double)                                             │
├─────────────────────────────────────────────────────────────────────┤
│ mcu_timestamp (单位: 秒)                                           │
└─────────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────────┐
│ 错误包率 (4字节, float)                                            │
├─────────────────────────────────────────────────────────────────────┤
│ (sensor_err_pkg_cnt / sensor_pkg_cnt) * 10000                     │
└─────────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────────┐
│ 传感器数据 (每个传感器17字节)                                      │
├─────────────────────────────────────────────────────────────────────┤
│ [SlaveID (1)] [UID32 (4)] [magX (4)] [magY (4)] [magZ (4)]        │
│    └─ 重复 sensor_num 次                                          │
└─────────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────────┐
│ CRC16校验 (2字节)                                                  │
├─────────────────────────────────────────────────────────────────────┤
│ CRC16 (多项式: 0x8005, 初值: 0xFFFF)                              │
└─────────────────────────────────────────────────────────────────────┘
```

### 数据包示例

```
位置    内容                            说明
────────────────────────────────────────────────────────────
0x00    0x55                            帧头标志1
0x01    0xAA                            帧头标志2
0x02    0xFF                            帧头标志3
0x03    0x03                            传感器数量 = 3
0x04    0x00 0x00 0x00 0x00 0x00 0x00 0x40 0x40    timestamp = 25.0s
0x0C    0x00 0x00 0x00 0x00              错误包率 = 0.0%
0x10    0x01                            传感器1 SlaveID
0x11    0x12 0x34 0x56 0x78              传感器1 UID
0x15    0x00 0x00 0x00 0x3F              magX = 0.5f
0x19    0x00 0x00 0x00 0x40              magY = 2.0f
0x1D    0x00 0x00 0x00 0x41              magZ = 8.0f
0x21    0x02                            传感器2 SlaveID
...     (重复)
0x??    0xAB 0xCD                        CRC16
```

---

## 配置命令格式（PC → MCU）

### 命令帧结构（PC → MCU）

```
┌─────────────────────────────────────────────────────────────────────┐
│ 帧头 (4字节)                                                        │
├─────────────────────────────────────────────────────────────────────┤
│ 0xAA | 0x55 | 0x00 | 0xFF                                         │
└─────────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────────┐
│ 命令类型 (1字节)                                                    │
├─────────────────────────────────────────────────────────────────────┤
│ 0x01=数据采集控制 | 0x02=设置配置 | 0x03=读取配置                  │
└─────────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────────┐
│ 数据长度 (1字节)                                                    │
├─────────────────────────────────────────────────────────────────────┤
│ 数据字节数 N                                                        │
└─────────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────────┐
│ 数据内容 (N字节)                                                    │
├─────────────────────────────────────────────────────────────────────┤
│ 根据命令类型变化                                                    │
└─────────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────────┐
│ CRC16校验 (2字节)                                                  │
├─────────────────────────────────────────────────────────────────────┤
│ 从帧头开始计算                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 响应帧结构（MCU → PC）

```
┌─────────────────────────────────────────────────────────────────────┐
│ 帧头 (3字节)                                                        │
├─────────────────────────────────────────────────────────────────────┤
│ 0x55 | 0xAA | 0xFF                                                 │
└─────────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────────┐
│ 数据内容 (N字节)                                                    │
├─────────────────────────────────────────────────────────────────────┤
│ 根据命令类型变化                                                    │
└─────────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────────┐
│ CRC16校验 (2字节)                                                  │
├─────────────────────────────────────────────────────────────────────┤
│ 从帧头开始计算                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 命令类型说明

#### CMD01: 数据采集控制

**请求格式：**
```
| 0xAA 0x55 0x00 0xFF | 0x01 | 0x01 | [0=停止,1=开始] | CRC16_L | CRC16_H |
```

#### CMD02: 设置传感器配置

**请求格式：**
```
| 0xAA 0x55 0x00 0xFF | 0x02 | LEN | [SlaveID] [StartReg] [Length] [Data...] | CRC16 |
```

**响应格式：**
```
| 0x55 0xAA 0xFF | [RS485响应数据] | CRC16 |
```

#### CMD03: 读取传感器配置

**请求格式：**
```
| 0xAA 0x55 0x00 0xFF | 0x03 | 0x01 | [SlaveID] | CRC16 |
```

**响应格式：**
```
| 0x55 0xAA 0xFF | SENSOR_Public_Config_t(52字节) | CRC16 |
```

---

## 配置命令格式（旧版，已弃用）

### 设置传感器配置（PC → MCU → RS485）

**USB接收格式：**
```
| SlaveID (1) | StartReg (1) | Length (1) | Data (N) |
```

**处理流程：**
```c
// main.c: 199-227
if(usb_set_sensor_cfg_flag == 1) {
    Set_MagSensor_Config(usb_to_485_buf);
    // 回复: 0x55 0xaa 0xff [原RS485响应] [CRC16]
    usb_set_sensor_cfg_flag = 0;
}
```

**USB响应格式：**
```
┌────────────────────────────────────────┐
│ 0x55 | 0xaa | 0xff                     │  帧头 (3字节)
├────────────────────────────────────────┤
│ [RS485响应数据]                        │  原样回显
├────────────────────────────────────────┤
│ CRC16 (2)                              │  校验
└────────────────────────────────────────┘
```

### 读取传感器配置（PC → MCU → RS485）

**USB接收格式：**
```
| SlaveID (1) | 请求读取配置 |
```

**USB响应格式：**
```
┌────────────────────────────────────────┐
│ 0x55 | 0xaa | 0xff                     │  帧头 (3字节)
├────────────────────────────────────────┤
│ SENSOR_Public_Config_t (52字节)        │  传感器公共配置
├────────────────────────────────────────┤
│ CRC16 (2)                              │  校验
└────────────────────────────────────────┘
```

---

## Modbus命令说明

| 命令码 | 功能 | 方向 |
|-------|------|-----|
| CMD50 (0x50) | 读寄存器 | MCU → 传感器 |
| CMD51 (0x51) | 写寄存器 | MCU → 传感器 |
| CMD60 (0x60) | 触发测量 | MCU → 传感器 |
| CMD61 (0x61) | 请求UID广播 | MCU → 0xF7 |
| CMD62 (0x62) | 设置SlaveID | MCU → 0xF7 |

---

## 注意事项

### 1. 电源时序

```
上电顺序:
1. MCU上电
2. 初始化所有外设
3. SENS_PWR_EN = HIGH (PB9输出高电平)
4. 等待1000ms (传感器稳定时间)
5. 开始传感器检测
```

### 2. RS485通信

- **波特率**: 2Mbps（通过CubeMX配置UART4）
- **总线空闲**: 需要5ms超时检测帧结束
- **DMA接收**: 使用`HAL_UARTEx_ReceiveToIdle_DMA()`
- **终端电阻**: 总线两端需要120Ω电阻

### 3. USB通信

- **虚拟串口**: CDC类，驱动自动识别
- **发送缓冲**: 2048字节 (APP_TX_DATA_SIZE)
- **接收缓冲**: 2048字节 (APP_RX_DATA_SIZE)
- **HS/FS切换**: 通过`USE_USB_HS`宏统一配置

### 4. 传感器地址

- **有效地址**: 0x01 ~ 0xF6 (1~246)
- **广播地址**: 0x00
- **临时地址**: 0xF7 (未分配ID时使用)
- **保留地址**: 0xF8 ~ 0xFF

### 5. 时间戳

- **单位**: 秒 (double精度)
- **基准**: TIM2定时器计数
- **同步**: 可通过写寄存器同步传感器时间

### 6. 调试输出

启用`USE_USB_PRINTF`宏可在USB串口输出调试信息：

```c
// usbd_cdc_if.h
#define USE_USB_PRINTF  1    // 0=关闭, 1=开启
```

### 7. 看门狗配置

系统使用独立看门狗(IWDG)监控程序运行状态，**默认关闭**。

**看门狗参数**：
- **时钟源**: LSI 32kHz (内部低速时钟)
- **预分频**: 64
- **重载值**: 4095
- **超时时间**: ≈ 8.2秒

`超时时间 = (Reload + 1) × 预分频 / LSI频率 = 4096 × 64 / 32000 ≈ 8.2秒`

**功能开关**（main.c）：

```c
// 启用看门狗
#define USE_IWDG    1

// 禁用看门狗（默认，调试时建议关闭）
#define USE_IWDG    0
```

**喂狗策略**：
- **初始化阶段**: 上电延时后喂1次，初始化完成后喂1次
- **主循环**: 每500ms喂1次（LED闪烁时同步）

**注意事项**：
- 程序异常（死循环、死锁）时看门狗会复位系统
- 调试时可关闭看门狗避免误触发
- 如需修改超时时间，需同时调整`Reload`值和预分频系数

### 8. 内存分配

**芯片**: STM32F722RE
- **FLASH**: 512KB @ 0x08000000
- **RAM**: 256KB @ 0x20000000

**内存布局**:
```
0x08000000                    0x20000000
┌──────────────┐             ┌──────────────┐
│   FLASH      │             │     RAM      │
│   .text      │             │  .data       │
│   (代码)     │             │  .bss        │
│              │             │              │
│              │             │  ┌─────────┐ │
│              │             │  │mag_sensor│ │ 61.3KB
│              │             │  │  [246]  │ │ @0x20004438
│              │             │  └─────────┘ │
│              │             │              │
│              │             │  rx_buf/tx_buf │ 512B
│              │             │  PC_Trans_Buff │ 1KB
│              │             │  栈           │ 16KB
│              │             │  堆           │ 8KB
└──────────────┘             └──────────────┘
```

**关键数据结构内存占用**:

| 数据项 | 类型 | 大小 | 地址 |
|--------|------|------|------|
| mag_sensor[246] | MY_SENSOR_module_t数组 | 61.3KB | 0x20004438 |
| rx_buf | uint8_t数组 | 256B | .bss段 |
| tx_buf | uint8_t数组 | 256B | .bss段 |
| PC_Trans_Buff | uint8_t数组 | 1KB | .bss段 |
| sensor_UID | 指针数组[246] | 984B | .bss段 |

**单个传感器结构体** (255 bytes):
```c
typedef struct {
    // 配置数据 (205 bytes)
    SENSOR_Public_Config_t   sensor_pub_cfg;
    MAG_Public_Config_t      mag_pub_cfg;
    IMU_Public_Config_t      imu_pub_cfg;
    LED_Public_Config_t      led_pub_cfg;
    SENSOR_Private_Config_t  sensor_prv_cfg;
    MAG_Private_Config_t     mag_prv_cfg;
    IMU_Private_Config_t     imu_prv_cfg;
    LED_Private_Config_t     led_prv_cfg;
    uint16_t                 cfg_crc16;

    // 只读数据 (50 bytes)
    SENSOR_Data_t            sensor_data;    // 17 bytes
    MAG_Data_t               mag_data;       // 40 bytes (含padding)
    IMU_Data_t               imu_data;       // 50 bytes (含padding)
} MY_SENSOR_module_t;
```

**内存使用估算** (RelWithDebInfo配置):
```
总RAM:  256KB
已用:    ~105KB (41%)
剩余:    ~151KB (59%)
```

**DMA缓冲区说明**:
- STM32F722使用统一RAM架构，所有数据在0x20000000
- 无D-Cache，DMA访问无需缓存维护
- DMA缓冲区(rx_buf/tx_buf)直接放在.bss段
- 与H743多RAM架构相比，F722配置更简单但性能略低

**与STM32H743对比**:

| 特性 | STM32F722RE | STM32H743VGT6 |
|------|-------------|---------------|
| RAM配置 | 单一256KB | 多区域1056KB |
| DMA优化 | 统一RAM | 专用DMA RAM (RAM_D2) |
| Cache | 无 | 有D-Cache需维护 |
| mag_sensor位置 | .bss @ 0x20004438 | .bss @ 0x24000000 |

---

## 目录结构

```
TheBox_v3_camke/
├── Core/
│   ├── Inc/           # 头文件
│   └── Src/           # 源文件 (main.c, stm32f7xx_it.c等)
├── Drivers/           # STM32 HAL驱动
├── Middlewares/       # USB设备库
├── USB_DEVICE/        # USB CDC实现
├── modbus_rtu/        # Modbus RTU协议层
├── ICM42688P/         # IMU驱动
├── usb_comm/          # USB通信封装层
├── cmake/             # CMake构建配置
├── build/             # 编译输出目录
└── README.md          # 本文档
```

---

## 版本历史

| 版本 | 日期 | 说明 |
|-----|------|-----|
| V1.0 | 2026-01 | STM32F722移植，USB通信替代UDP |

---

## 许可证

Copyright (c) 2026 STMicroelectronics. All rights reserved.
